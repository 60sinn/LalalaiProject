{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="min-h-screen bg-pink-50 py-10 px-4 relative">
  <div class="max-w-3xl mx-auto bg-white rounded-2xl p-8 shadow-xl border border-pink-100">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">üë§ –õ–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</h1>

    <form method="post" enctype="multipart/form-data" id="profileForm" class="space-y-6">
      {% csrf_token %}

      <!-- –ê–≤–∞—Ç–∞—Ä -->
      <div>
        <p class="text-pink-600 font-semibold mb-2">–ê–≤–∞—Ç–∞—Ä:</p>
        <div class="flex items-center gap-4">
          {% if user.avatar %}
            <img src="{{ user.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="w-24 h-24 rounded-full object-cover ring-2 ring-pink-300 shadow">
          {% else %}
            <div class="w-24 h-24 bg-purple-200 text-white rounded-full flex items-center justify-center text-3xl font-bold">
              {{ user.username|slice:":1"|upper }}
            </div>
          {% endif %}
          <button type="button" onclick="toggleEdit('avatar')" class="text-sm text-blue-600 hover:underline">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</button>
        </div>
        <div id="avatarForm" class="{% if form.avatar.errors %}flex{% else %}hidden{% endif %} mt-3 flex items-center gap-3">
          {{ form.avatar|add_class:"text-sm text-gray-700 bg-white border rounded-md px-2 py-1" }}
          <button type="submit" class="text-sm px-3 py-1 bg-pink-500 text-white rounded hover:bg-pink-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        {% if form.avatar.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.avatar.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- –ù–∏–∫ -->
      <div>
        <p class="text-pink-600 font-semibold">–ù–∏–∫:</p>
        <div id="usernameDisplay" class="flex items-center gap-2">
          <span class="text-gray-800">{{ user.username }}</span>
          <button type="button" onclick="toggleEdit('username')" class="text-sm text-blue-600 hover:underline">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div id="usernameForm" class="{% if form.username.errors %}flex{% else %}hidden{% endif %} flex items-center gap-2 mt-1">
          {{ form.username|add_class:"border rounded-md px-3 py-1 text-gray-800" }}
          <button type="submit" class="text-sm px-3 py-1 bg-pink-500 text-white rounded hover:bg-pink-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        {% if form.username.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.username.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Email -->
      <div>
        <p class="text-pink-600 font-semibold">Email:</p>
        <div id="emailDisplay" class="flex items-center gap-2">
          <span class="text-gray-800">{{ user.email }}</span>
          <button type="button" onclick="toggleEdit('email')" class="text-sm text-blue-600 hover:underline">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div id="emailForm" class="{% if form.email.errors %}flex{% else %}hidden{% endif %} flex items-center gap-2 mt-1">
          {{ form.email|add_class:"border rounded-md px-3 py-1 text-gray-800" }}
          <button type="submit" class="text-sm px-3 py-1 bg-pink-500 text-white rounded hover:bg-pink-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        {% if form.email.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.email.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
      <div>
        <p class="text-pink-600 font-semibold">–û–ø–∏—Å–∞–Ω–∏–µ:</p>
        <div id="bioDisplay" class="text-gray-800">
          {% if user.bio %}
            <p class="whitespace-pre-line">{{ user.bio }}</p>
          {% else %}
            <span class="italic text-gray-400">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ.</span>
          {% endif %}
          <button type="button" onclick="toggleEdit('bio')" class="text-sm text-blue-600 hover:underline mt-1">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
        </div>
        <div id="bioForm" class="{% if form.bio.errors %}block{% else %}hidden{% endif %} mt-2">
          {{ form.bio|add_class:"w-full h-28 border rounded-md px-3 py-2 text-gray-800" }}
          <button type="submit" class="mt-2 text-sm px-3 py-1 bg-pink-500 text-white rounded hover:bg-pink-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        {% if form.bio.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.bio.errors.0 }}</p>
        {% endif %}
      </div>
    </form>

    <!-- –î–æ–ø. –∏–Ω—Ñ–æ -->
    <div class="mt-8 text-sm text-gray-600">
      <p><strong>–†–æ–ª—å:</strong> {{ user.get_role_display }}</p>
      <p><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> {{ user.date_joined|date:"d.m.Y" }}</p>
      <a href="{% url 'logout' %}" class="text-red-500 hover:underline mt-2 inline-block">üö™ –í—ã–π—Ç–∏</a>
    </div>
  </div>

  {% if form.errors %}
  <div id="formErrorToast" class="fixed bottom-6 left-6 z-50 bg-red-100/80 border border-red-400 text-red-900 px-4 py-3 rounded-lg shadow-xl animate-toast w-80 backdrop-blur-md">
    <div class="font-semibold mb-1">‚ùó –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:</div>
    <ul class="list-disc list-inside text-sm space-y-1">
      {% for field in form %}
        {% for error in field.errors %}
          <li><strong>{{ field.label }}:</strong> {{ error }}</li>
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>

<script>
  function toggleEdit(field) {
    document.getElementById(`${field}Display`)?.classList.add('hidden');
    document.getElementById(`${field}Form`)?.classList.remove('hidden');
    const input = document.querySelector(`#${field}Form input, #${field}Form textarea`);
    if (input) input.focus();
  }

  setTimeout(() => {
    const toast = document.getElementById("formErrorToast");
    if (toast) toast.remove();
  }, 5000);
</script>

<style>
  @keyframes toast-slide {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .animate-toast {
    animation: toast-slide 0.4s ease-out;
  }
</style>
{% endblock %}
